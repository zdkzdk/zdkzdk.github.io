<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="generator" content="Aspose.Words for .NET 15.1.0.0" /><title></title></head><body><div><h2 style="margin:0pt 0pt 6pt 14.15pt; text-indent:0pt"><span style="font-family:等线; font-size:14pt; font-style:normal">1.</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">kafka</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">同</span><span style="font-family:等线; font-size:11pt; font-weight:bold">SparkStreaming</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的整合</span></h2><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">src</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">SStreaming</span><span style="font-family:宋体; font-size:11pt">只能兼容</span><span style="font-family:等线; font-size:11pt">0.8.2.1</span><span style="font-family:宋体; font-size:11pt">之后的</span><span style="font-family:等线; font-size:11pt">kafka</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:42pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.001.png" width="959" height="29" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">spark</span><span style="font-family:宋体; font-size:11pt">官方提供了</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">maven</span><span style="font-family:宋体; font-size:11pt">依赖，一个是</span><span style="font-family:等线; font-size:11pt">0</span><span style="font-family:等线; font-size:11pt">-8</span><span style="font-family:宋体; font-size:11pt">，一个</span><span style="font-family:等线; font-size:11pt">0-10</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">0-8</span><span style="font-family:宋体; font-size:11pt">兼容</span><span style="font-family:等线; font-size:11pt">0</span><span style="font-family:等线; font-size:11pt">.8</span><span style="font-family:宋体; font-size:11pt">之后的，但</span><span style="font-family:等线; font-size:11pt">0-10</span><span style="font-family:宋体; font-size:11pt">不兼容之前的</span></h4><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">1.6 + 0.8.2</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">2.3</span><span style="font-family:宋体; font-size:11pt">推荐</span><span style="font-family:等线; font-size:11pt">1.0+</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">0.9</span><span style="font-family:宋体; font-size:11pt">一般不用</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.002.png" width="531" height="68" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">区别</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">代码层面，创建</span><span style="font-family:等线; font-size:11pt">DStream</span><span style="font-family:宋体; font-size:11pt">不同，使用上都一样</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">高低阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">的区别就是</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">如何维护，高阶是通过</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">，低阶自定义</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.5</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">note</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">partition</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">partition</span><span style="font-family:宋体; font-size:11pt">不同，</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">生产环境一般不联网不下载</span><span style="font-family:等线; font-size:11pt">jar</span><span style="font-family:宋体; font-size:11pt">，使用</span><span style="font-family:等线; font-size:11pt">--jars</span><span style="font-family:宋体; font-size:11pt">参数来指定</span><span style="font-family:等线; font-size:11pt">jar</span></h5><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">com</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">SStreaming</span><span style="font-family:宋体; font-size:11pt">从</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">获取数据有</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">种方式。</span></h4><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">基于</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">的方式，底层使用</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">高阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">的，有可能会丢失数据，因为</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">先向</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">提交当前批次数据的</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，然后再向</span><span style="font-family:等线; font-size:11pt">driver</span><span style="font-family:宋体; font-size:11pt">申请调度，如果处理过程</span><span style="font-family:等线; font-size:11pt">driver</span><span style="font-family:宋体; font-size:11pt">宕机，恢复后会从</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">获取</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">。为了避免这种情况，可以使用开启</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:宋体; font-size:11pt">机制，</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">额外向</span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">备份一份数据，这样即使宕机，也可以根据</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">从</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">取数据</span></h4><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">基于</span></h4><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">1.6 + </span><span style="font-family:等线; font-size:11pt; font-weight:bold">&gt;</span><span style="font-family:等线; font-size:11pt; font-weight:bold">0.8.0</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">有</span><span style="font-family:等线; font-size:11pt; font-weight:bold">2</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">种模式，</span><span style="font-family:等线; font-size:11pt; font-weight:bold">Receiver</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">模式</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">使用</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">高阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">，</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">s</span><span style="font-family:等线; font-size:11pt">park</span><span style="font-family:宋体; font-size:11pt">使用</span><span style="font-family:等线; font-size:11pt">worker</span><span style="font-family:宋体; font-size:11pt">中的</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">接收数据，存到</span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">的内存中，默认会丢失数据。为了不丢失数据，需要开启</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:宋体; font-size:11pt">机制，</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">spark1.2</span><span style="font-family:宋体; font-size:11pt">后才有，</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">com</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">需要一个</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">作为</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">接收数据，也就是</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">的消费者。</span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">直接从</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">读数据，因为要一直读，所以需要一个</span><span style="font-family:等线; font-size:11pt">receiverTask</span><span style="font-family:宋体; font-size:11pt">线程一直运行，专门干接收的事。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">流程</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">有线程池。只要消费者获取完数据，也就是</span><span style="font-family:等线; font-size:11pt">Executor</span><span style="font-family:宋体; font-size:11pt">把数据接受完并按照持久化规则存到各个</span><span style="font-family:等线; font-size:11pt">Executor</span><span style="font-family:宋体; font-size:11pt">的节点上，此时就要向</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">上</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">管理节点提交更新。</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">receiverTask也是个task，也可以持久化，接收数据默认级别是MADS2，将数据备份到2台executor上。所以在数据接收这个阶段，数据丢失概率很小。</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">更新完</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">receiverTask</span><span style="font-family:宋体; font-size:11pt">会把数据备份的位置也就是持久化的位置汇报给</span><span style="font-family:等线; font-size:11pt">driver</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">driver</span><span style="font-family:宋体; font-size:11pt">有了要处理的数据信息，就可以调度任务，开始处理数据</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:84pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.003.png" width="976" height="413" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">问题</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">：</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">模式</span><span style="font-family:等线; font-size:11pt">,</span><span style="font-family:宋体; font-size:11pt">需要一个</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">一</span><span style="font-family:宋体; font-size:11pt">直处于接收数据的状态</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">接收来的数据存储级别</span><span style="font-family:等线; font-size:11pt">MEMORY _AND_ DISK_ SER_ 2</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:宋体; font-size:11pt">这种模式</span><span style="font-family:宋体; font-size:11pt">下</span><span style="font-family:宋体; font-size:11pt">当</span><span style="font-family:等线; font-size:11pt">Driver</span><span style="font-family:宋体; font-size:11pt">挂</span><span style="font-family:宋体; font-size:11pt">掉时</span><span style="font-family:等线; font-size:11pt">, </span><span style="font-family:宋体; font-size:11pt">同</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">App</span><span style="font-family:宋体; font-size:11pt">下的</span><span style="font-family:等线; font-size:11pt">Executor</span><span style="font-family:宋体; font-size:11pt">也会被</span><span style="font-family:等线; font-size:11pt">K</span><span style="font-family:等线; font-size:11pt">ill</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">Executor</span><span style="font-family:宋体; font-size:11pt">有可能有一部分数据未被处理，就存在丢失数据的问题</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》数据是接收成功就向</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">提交</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，此时数据还没处理完，如果提交完但处理时宕机，就会丢失数据</span><span style="font-family:宋体; font-size:11pt"> </span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">开启</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:宋体; font-size:11pt">机制</span><span style="font-family:等线; font-size:11pt">( Write Ahead Log )</span><span style="font-family:宋体; font-size:11pt">预写日志级别</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">将数据节点之间备份完成之</span><span style="font-family:宋体; font-size:11pt">后再</span><span style="font-family:宋体; font-size:11pt">向</span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">中备份</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">份</span><span style="font-family:宋体; font-size:11pt">，然后向</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">提交</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》优点</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">持久化等级不需要带_2了，因为hdfs自带备份。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">宕机恢复时，从hdfs读数据</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">。</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">==》</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">开启</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">WAL机制带来新的问题:加大了数据处理延迟,开启WAL机制</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">问题</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">：</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">模式底层读取</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">消费者的实现采用了</span><span style="font-family:等线; font-size:11pt">high level consumer API</span><span style="font-family:宋体; font-size:11pt">，不提供维护</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">的接口，只关心数据不能手动管理</span><span style="font-family:等线; font-size:11pt">offset</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">这种模式已经被废弃，新版本已经没有</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">采用了</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">接收器，要先把数据存到</span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">中再处理，再有任务堆积的情况下，内存占用更大</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">存在丢失数据的问题，开启</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:宋体; font-size:11pt">可以避免，加大了数据处理的延迟</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">底层采用了</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">高阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">来消费，不能手动维护</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，也就是不能指定</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">的存储位置，不能指定</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">消费。比如消费</span><span style="font-family:等线; font-size:11pt">3</span><span style="font-family:宋体; font-size:11pt">个分区的</span><span style="font-family:等线; font-size:11pt">topic</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">分别是</span><span style="font-family:等线; font-size:11pt">100</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">90</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">80</span><span style="font-family:宋体; font-size:11pt">，想要从</span><span style="font-family:等线; font-size:11pt">110</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">100</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">90</span><span style="font-family:宋体; font-size:11pt">开始消费做不到。</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">如果是处理日志数据，丢几条无所谓，但有些场景比如金融，要求数据不能丢，要求精确处理</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">不使用</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">模式还</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个原因是因为</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">模式并行度，并行度由</span><span style="font-family:等线; font-size:11pt">spark.streaming.blockInterval</span><span style="font-family:宋体; font-size:11pt">决定，不灵活，最小不能低于</span><span style="font-family:等线; font-size:11pt">50ms</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">个参数，</span><span style="font-family:等线; font-size:11pt">blockInterval</span><span style="font-family:宋体; font-size:11pt">是每隔多久把数据封装为一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">batchInterval</span><span style="font-family:宋体; font-size:11pt">是隔多久把这些</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">封装为</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">batch</span><span style="font-family:宋体; font-size:11pt">。多个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">封装为</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">batch</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">batch</span><span style="font-family:宋体; font-size:11pt">封装为</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">对应</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">partition</span><span style="font-family:宋体; font-size:11pt">，所以导致</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">的并行度会跟</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">一样，会很多</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">batchInternal就是创建ssc时的参数2</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">blockInterval</span><span style="font-family:宋体; font-size:11pt">如果过小，导致并行度过高，</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的数据过小，</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">启动时间比处理时间不成比例。</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.004.png" width="929" height="172" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">API</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:63pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.005.png" width="921" height="358" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建，需要传入</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">地址。单纯创建不需要使用</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">。创建时需要指定消费者组，会自动创建</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">使用上没有特别之处。</span></h5><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">1.6 + </span><span style="font-family:等线; font-size:11pt; font-weight:bold">&gt;</span><span style="font-family:等线; font-size:11pt; font-weight:bold">0.8.0</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">direct</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">模式</span></h3><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:52.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.006.png" width="583" height="480" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.4.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">跟</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">相比</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">取数据方式不同。使用低阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">直接根据</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">从</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">分区中读，可以手动管理</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">。没有</span><span style="font-family:等线; font-size:11pt">receiver</span><span style="font-family:宋体; font-size:11pt">，随处理随获取，内存占用少</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">并行度设置不同，并行度跟要读的</span><span style="font-family:等线; font-size:11pt">topic</span><span style="font-family:宋体; font-size:11pt">的分区数相同，一个</span><span style="font-family:等线; font-size:11pt">kafka topic</span><span style="font-family:宋体; font-size:11pt">的分区对应</span><span style="font-family:等线; font-size:11pt">DStream</span><span style="font-family:宋体; font-size:11pt">中</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">的分区，是</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">对</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">的关系，后续想要改变分区数用算子改即可</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">不用</span><span style="font-family:等线; font-size:11pt">zk</span><span style="font-family:宋体; font-size:11pt">管理</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">spark</span><span style="font-family:宋体; font-size:11pt">自己管理，默认将</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">存在内存，如果设置了</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">，在</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">也会备份，也可以自定义保存到</span><span style="font-family:等线; font-size:11pt">mysql</span><span style="font-family:宋体; font-size:11pt">或</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">中。创建</span><span style="font-family:等线; font-size:11pt">DStream</span><span style="font-family:宋体; font-size:11pt">时不需要</span><span style="font-family:等线; font-size:11pt">zk</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">代码上</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建</span><span style="font-family:等线; font-size:11pt">DStream</span><span style="font-family:宋体; font-size:11pt">不同</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">checkpoint也不是必须，但因为内存中的数据重启之后就没了，所以实际上是必须的。创建DStream时有个构造器可以传入ck的路径，这样重启时就可以从ck获取上次的数据</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">用KifkaUtils.createDirectStream创建，不需要设置zk，receiver模式用createStream，需要设置zk。</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.007.png" width="580" height="110" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.008.png" width="673" height="121" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">保存到</span><span style="font-family:等线; font-size:11pt">ck</span><span style="font-family:宋体; font-size:11pt">时，不能修改逻辑，就不能重复使用</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">，所以一般不用</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》手动维护，也可以把</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">存到外部存储</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">手动维护</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">消费完获取offset并保存</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><span style="font-family:等线; font-size:10.5pt">transform算子用来对DStream中的RDD进行转换，相当于DStream的map，返回值也必须是RDD</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><span style="font-family:等线; font-size:10.5pt">RDD应该是继承了OffsetRange的特质，使用transform把RDD转成OffsetRange类型，然后就可以获取offsetRanges这个集合</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.009.png" width="591" height="294" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 73.5pt; text-indent:21pt"><span style="font-family:等线; font-size:10.5pt">从rdd中可以获取当前RDD的消费信息，包括topic，partition，起止offset</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">下一次启动时，从中介存储中获取offset，然后创建DStream时把offset传入，跟driverHA的代码相同</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">，这种方式可能会造成重复处理，因为数据以批为单位，上一批没处理完，这一批会从头开始消费。</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 99.25pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">1st</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">TopicAndPartition指明topic和分区，Long指明offset</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:84pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.010.png" width="1237" height="28" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.5</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">2.3</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">+</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> &gt;</span><span style="font-family:等线; font-size:11pt; font-weight:bold">0.10</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">之后，</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">com</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">只有</span><span style="font-family:等线; font-size:11pt">direct</span><span style="font-family:宋体; font-size:11pt">模式，也不再分高低阶</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">。使用</span><span style="font-family:等线; font-size:11pt">_</span><span style="font-family:等线; font-size:11pt">_consumer_offsets</span><span style="font-family:宋体; font-size:11pt">维护</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，不用</span><span style="font-family:等线; font-size:11pt">zk</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">2.3</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">sparkStreaming</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">direct</span><span style="font-family:宋体; font-size:11pt">模式，和</span><span style="font-family:等线; font-size:11pt">1.6</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">direct</span><span style="font-family:宋体; font-size:11pt">模式类似，只不过使用的</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">不同，</span><span style="font-family:等线; font-size:11pt">2.3</span><span style="font-family:宋体; font-size:11pt">不再分高低阶，只有一个</span><span style="font-family:等线; font-size:11pt">newAPI</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">参数</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">auto.offset.reset</span><span style="font-family:宋体; font-size:11pt">：</span><span style="font-family:等线; font-size:11pt">sparkStreaming</span><span style="font-family:宋体; font-size:11pt">连接上</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">后，从哪里开始消费</span></h5><p style="background-color:#e0e0e0; line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt; orphans:0; text-align:justify; widows:0"><span style="font-family:'Courier New'; font-size:12pt">earliest</span><span style="font-family:宋体; font-size:12pt">：各分区下有已提交的</span><span style="font-family:'Courier New'; font-size:12pt">offset</span><span style="font-family:宋体; font-size:12pt">时，从提交的</span><span style="font-family:'Courier New'; font-size:12pt">offset</span><span style="font-family:宋体; font-size:12pt">开始消费，无提交的</span><span style="font-family:'Courier New'; font-size:12pt">offset</span><span style="font-family:宋体; font-size:12pt">，从头开始</span></p><p style="background-color:#e0e0e0; line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt; orphans:0; text-align:justify; widows:0"><span style="font-family:'Courier New'; font-size:12pt">latest</span><span style="font-family:宋体; font-size:12pt">：默认，从最新的</span><span style="font-family:'Courier New'; font-size:12pt">offset</span><span style="font-family:宋体; font-size:12pt">开始消费，也就是连上</span><span style="font-family:'Courier New'; font-size:12pt">kafka</span><span style="font-family:宋体; font-size:12pt">时，直接从</span><span style="font-family:'Courier New'; font-size:12pt">kafka</span><span style="font-family:宋体; font-size:12pt">发来的开始消费</span></p><p style="background-color:#e0e0e0; line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt; orphans:0; text-align:justify; widows:0"><span style="font-family:'Courier New'; font-size:12pt">none</span><span style="font-family:宋体; font-size:12pt">：没找到以前的</span><span style="font-family:'Courier New'; font-size:12pt">offset</span><span style="font-family:宋体; font-size:12pt">，就抛出异常</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">enable.auto.commit</span><span style="font-family:宋体; font-size:11pt">：</span><span style="font-family:等线; font-size:11pt">true</span><span style="font-family:宋体; font-size:11pt">时每隔一段时间自动提交</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，会有数据丢失的问题。</span><span style="font-family:等线; font-size:11pt">false</span><span style="font-family:宋体; font-size:11pt">需要手动提交。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">heartbeat.interval.ms</span><span style="font-family:宋体; font-size:11pt">：表示</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">集群与</span><span style="font-family:等线; font-size:11pt">consumer</span><span style="font-family:宋体; font-size:11pt">之间心跳间隔时间，这个值必须比</span><span style="font-family:等线; font-size:11pt">session.timout.ms</span><span style="font-family:宋体; font-size:11pt">小，一般不大于</span><span style="font-family:等线; font-size:11pt">session.timout.ms</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">1/3</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">session.timout.ms</span><span style="font-family:宋体; font-size:11pt">：表示消费者与</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">之间的</span><span style="font-family:等线; font-size:11pt">session</span><span style="font-family:宋体; font-size:11pt">会话超时时间，如果这个时间内没有收到消费者的心跳，会移除当前消费者，默认是</span><span style="font-family:等线; font-size:11pt">30s</span><span style="font-family:宋体; font-size:11pt">。这个时间介于</span><span style="font-family:等线; font-size:11pt">group.min.session.timeout.ms</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">group.max.session.timeout.ms</span><span style="font-family:宋体; font-size:11pt">之间，如果</span><span style="font-family:等线; font-size:11pt">batchInterval</span><span style="font-family:宋体; font-size:11pt">大于</span><span style="font-family:等线; font-size:11pt">5</span><span style="font-family:宋体; font-size:11pt">分钟，就要调大</span><span style="font-family:等线; font-size:11pt">group.max.session.timeout.ms</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">的维护，在哪存，存取</span><span style="font-family:等线; font-size:11pt">API</span><span style="font-family:宋体; font-size:11pt">？</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">如果设置了</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">，会存在</span><span style="font-family:等线; font-size:11pt">checkpoint</span><span style="font-family:宋体; font-size:11pt">中。缺点</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">从</span><span style="font-family:等线; font-size:11pt">ckp</span><span style="font-family:宋体; font-size:11pt">恢复数据时，有可能造成重复消费</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">代码逻辑改变时，</span><span style="font-family:等线; font-size:11pt">ckp</span><span style="font-family:宋体; font-size:11pt">无法使用</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">使用</span><span style="font-family:等线; font-size:11pt">kafka</span><span style="font-family:宋体; font-size:11pt">的系统</span><span style="font-family:等线; font-size:11pt">topic</span><span style="font-family:宋体; font-size:11pt">，但</span><span style="font-family:等线; font-size:11pt">_</span><span style="font-family:等线; font-size:11pt">_consumer_offsets</span><span style="font-family:宋体; font-size:11pt">数据有保存期限，默认</span><span style="font-family:等线; font-size:11pt">24</span><span style="font-family:宋体; font-size:11pt">小时，如果宕机超过</span><span style="font-family:等线; font-size:11pt">24</span><span style="font-family:宋体; font-size:11pt">小时，就没了。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">自定义</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">从自定义存储查询</span><span style="font-family:等线; font-size:11pt">topic</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">partition</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">，封装成</span><span style="font-family:等线; font-size:11pt">TopicPartition</span><span style="font-family:宋体; font-size:11pt">对象，然后转成</span><span style="font-family:等线; font-size:11pt">map</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建</span><span style="font-family:等线; font-size:11pt">stream</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.011.png" width="776" height="481" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">API</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.012.png" width="596" height="467" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">不需要传什么</span><span style="font-family:等线; font-size:11pt">kv</span><span style="font-family:宋体; font-size:11pt">类型和节码类</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">消费策略，就是</span><span style="font-family:等线; font-size:11pt">topic</span><span style="font-family:宋体; font-size:11pt">的分区在</span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">中如何分配</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">一般采用LocationStrategies.PreferConsistent策略，会将topic分区均匀分布在executor中，</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果spark的executor跟kafka的broker在同意节点上，可以使用PreferBrokers，则executor的数据从本地节点获取</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(3)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果节点之间的分区分布不均，可用PreferFixed，通过一个map指定topic分区和executor的分配</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Subscribe</span><span style="font-family:宋体; font-size:11pt">，包括主题和</span><span style="font-family:等线; font-size:11pt">kakka</span><span style="font-family:宋体; font-size:11pt">配置</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.013.png" width="812" height="147" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">处理完后，更新</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》获取并异步提交</span><span style="font-family:等线; font-size:11pt">offset</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 77.95pt; text-indent:0pt"><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">提交</span><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">offset</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">的</span><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">stream</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">一定要用初始的</span><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">createDirectStream</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">方法创建的</span><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">stream</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">，不能是经过算子转换的。因为转换过的，</span><span style="background-color:#ffff00; color:#ff0000; font-family:等线; font-size:11pt">offset</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">的信息已经没有了。</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="d3f20c1d-a835-478e-9d53-0f11fa6f0a6f.014.png" width="860" height="236" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p></div></body></html>