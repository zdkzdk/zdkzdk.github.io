<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="generator" content="Aspose.Words for .NET 15.1.0.0" /><title></title></head><body><div><h2 style="margin:0pt 0pt 6pt 14.15pt; text-indent:0pt"><span style="font-family:等线; font-size:14pt; font-style:normal">1.</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">任务调度</span></h2><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">任务调度包括什么，做了什么？</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">action</span><span style="font-family:宋体; font-size:11pt">算子触发后，调用</span><span style="font-family:等线; font-size:11pt">DS</span><span style="font-family:宋体; font-size:11pt">对象的</span><span style="font-family:等线; font-size:11pt">runjob</span><span style="font-family:宋体; font-size:11pt">，将</span><span style="font-family:等线; font-size:11pt">thisRDD</span><span style="font-family:宋体; font-size:11pt">传入，递归划分</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">，最终封装到</span><span style="font-family:等线; font-size:11pt">resultStage</span><span style="font-family:宋体; font-size:11pt">，然后划分</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">，封装到</span><span style="font-family:等线; font-size:11pt">TaskSet</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">将</span><span style="font-family:等线; font-size:11pt">job</span><span style="font-family:宋体; font-size:11pt">划分为</span><span style="font-family:等线; font-size:11pt">resultStage</span><span style="font-family:宋体; font-size:11pt">，根据宽窄依赖划分</span><span style="font-family:等线; font-size:11pt">shuffleMapStage</span><span style="font-family:宋体; font-size:11pt">，根据分区数</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">提交给</span><span style="font-family:等线; font-size:11pt">TS</span><span style="font-family:宋体; font-size:11pt">，使用</span><span style="font-family:等线; font-size:11pt">RPC</span><span style="font-family:宋体; font-size:11pt">发给</span><span style="font-family:等线; font-size:11pt">w</span><span style="font-family:等线; font-size:11pt">orker</span><span style="font-family:宋体; font-size:11pt">上的</span><span style="font-family:等线; font-size:11pt">executor</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">threadpool</span><span style="font-family:宋体; font-size:11pt">执行</span></h4><p style="line-height:14pt; margin:7.8pt 0pt 7.8pt 7.35pt; text-indent:21pt"><span style="font-family:等线; font-size:14pt">文字分析</span><span style="font-family:等线; font-size:14pt">：</span></p><p style="line-height:14pt; margin:7.8pt 0pt 7.8pt 7.35pt; text-indent:21pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.001.png" width="554" height="168" alt="04_stage调度01" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">一个</span><span style="font-family:等线; font-size:11pt; font-weight:bold">job</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">，在最后的行动算子中，</span><span style="font-family:等线; font-size:11pt; font-weight:bold">RDD</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">会调用</span><span style="font-family:等线; font-size:11pt; font-weight:bold">sparkContext</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的</span><span style="font-family:等线; font-size:11pt; font-weight:bold">runjob</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">，</span><span style="font-family:等线; font-size:11pt; font-weight:bold">track</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">后，最终执行</span><span style="font-family:等线; font-size:11pt; font-weight:bold">dagScheduler</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的</span><span style="font-family:等线; font-size:11pt; font-weight:bold">runjob</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">，入参为</span><span style="font-family:等线; font-size:11pt; font-weight:bold">rdd</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">、分区列表、回调函数</span><span style="font-family:宋体; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">etc</span><span style="font-family:等线; font-size:11pt; font-weight:bold">.</span></h3><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:52.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.002.png" width="655" height="100" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:52.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.003.png" width="695" height="303" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">dagScheduler</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的</span><span style="font-family:等线; font-size:11pt; font-weight:bold">runjob</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">-</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">submitJob</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">eventProcessLoop </span><span style="font-family:宋体; font-size:11pt">是</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">DAGSchedulerEventProcessLoop </span><span style="font-family:宋体; font-size:11pt">对象</span><span style="font-family:宋体; font-size:11pt">，继承了</span><span style="font-family:等线; font-size:11pt">EventLoop</span><span style="font-family:宋体; font-size:11pt">类。</span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">post</span><span style="font-family:宋体; font-size:11pt">方法内维护了一个队列，在</span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">的抽象父类</span><span style="font-family:等线; font-size:11pt">EventLoop</span><span style="font-family:宋体; font-size:11pt">中会有一个</span><span style="font-family:等线; font-size:11pt">BlockingQueue</span><span style="font-family:宋体; font-size:11pt">的属性</span></h4><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">会向一个队列中</span><span style="font-family:等线; font-size:11pt">post</span><span style="font-family:宋体; font-size:11pt">一个</span><span style="font-family:等线; font-size:11pt">Submit</span><span style="font-family:宋体; font-size:11pt">对象</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》何时</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">？在一个线程中</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》线程何时</span><span style="font-family:等线; font-size:11pt">start</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》</span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">何时</span><span style="font-family:等线; font-size:11pt">start</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">是个</span><span style="font-family:等线; font-size:11pt">DAGSchedulerEventProcessLoop</span><span style="font-family:宋体; font-size:11pt">对象，继承了</span><span style="font-family:等线; font-size:11pt">EventLoop</span><span style="font-family:宋体; font-size:11pt">类</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">这个方法执行就会调用</span><span style="font-family:等线; font-size:11pt">eventQueue.take()</span><span style="font-family:宋体; font-size:11pt">，然后调用</span><span style="font-family:等线; font-size:11pt">onReceive</span><span style="font-family:等线; font-size:11pt">(event)</span><span style="font-family:宋体; font-size:11pt">，调用的是</span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">onReceive</span><span style="font-family:宋体; font-size:11pt">，父类没有这个方法。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">开始</span><span style="font-family:等线; font-size:11pt">case</span><span style="font-family:宋体; font-size:11pt">，刚才提交的是</span><span style="font-family:等线; font-size:11pt">JobSubmited</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">线程启动后，</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">将入参封装到</span><span style="font-family:等线; font-size:11pt">JobSubmitted</span><span style="font-family:宋体; font-size:11pt">然后调用</span><span style="font-family:等线; font-size:11pt">post</span><span style="font-family:宋体; font-size:11pt">方法放到队列中，一个</span><span style="font-family:等线; font-size:11pt">job</span><span style="font-family:宋体; font-size:11pt">就抽象为一个</span><span style="font-family:等线; font-size:11pt">event</span><span style="font-family:等线; font-size:11pt"> </span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">jdk1.6</span><span style="font-family:宋体; font-size:11pt">有了阻塞式队列和双端队列。</span><span style="font-family:等线; font-size:11pt">BlockingQueue</span><span style="font-family:宋体; font-size:11pt">中如果里面满了就会阻塞，取时如果没有也会阻塞。</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">放完了，何时</span><span style="font-family:等线; font-size:11pt">take</span><span style="font-family:宋体; font-size:11pt">取出来？</span><span style="font-family:等线; font-size:11pt">DAGSchedulerEventProcessLoop</span><span style="font-family:宋体; font-size:11pt">的父</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">抽象类</span><span style="color:#ff0000; font-family:等线; font-size:11pt">EventLoop</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">里会有</span><span style="color:#ff0000; font-family:等线; font-size:11pt">run</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">方法</span><span style="font-family:宋体; font-size:11pt">，在</span><span style="font-family:等线; font-size:11pt">DS</span><span style="font-family:宋体; font-size:11pt">创建时就会启动这个线程，里面把</span><span style="font-family:等线; font-size:11pt">event</span><span style="font-family:宋体; font-size:11pt">遍历出来。调用</span><span style="font-family:等线; font-size:11pt">onReceive==</span><span style="font-family:宋体; font-size:11pt">》</span><span style="font-family:等线; font-size:11pt">doOnReceive</span><span style="font-family:宋体; font-size:11pt">，模式匹配后执行</span><span style="font-family:等线; font-size:11pt">handleJobSubmitted</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">eventProcessLoop</span><span style="font-family:宋体; font-size:11pt">调用</span><span style="font-family:等线; font-size:11pt">start</span><span style="font-family:宋体; font-size:11pt">实际上调用的是父类</span><span style="font-family:等线; font-size:11pt">EventLoop</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">start</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">eventProcessLoop.</span><span style="font-family:等线; font-size:11pt">start</span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">DS</span><span style="font-family:宋体; font-size:11pt">类中，</span><span style="font-family:等线; font-size:11pt">DS</span><span style="font-family:宋体; font-size:11pt">创建，这个方法就执行</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">父</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">抽象类</span><span style="color:#ff0000; font-family:等线; font-size:11pt">EventLoop</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">的</span><span style="color:#ff0000; font-family:等线; font-size:11pt">run</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">，取出</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.004.png" width="576" height="246" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.5</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">然后调用子类的</span><span style="font-family:等线; font-size:11pt">onReceive</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">match</span><span style="font-family:宋体; font-size:11pt">后执行</span><span style="font-family:等线; font-size:11pt">handleJobSubmitted</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:63pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.005.png" width="702" height="233" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">handleJobSubmitted</span></h3><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 42pt; text-indent:21pt"><span style="font-family:等线; font-size:10.5pt">2个重要的方法</span><span style="font-family:等线; font-size:10.5pt">createResultStage</span><span style="font-family:等线; font-size:10.5pt">和</span><span style="font-family:等线; font-size:10.5pt">submitStage</span></p><table cellspacing="0" cellpadding="0" style="border-collapse:collapse; margin-left:49.25pt"><tr><td style="border-bottom-color:#000000; border-bottom-style:solid; border-bottom-width:0.75pt; border-left-color:#000000; border-left-style:solid; border-left-width:0.75pt; border-right-color:#000000; border-right-style:solid; border-right-width:0.75pt; border-top-color:#000000; border-top-style:solid; border-top-width:0.75pt; padding-left:5.03pt; padding-right:5.03pt; vertical-align:top; width:860.95pt"><p style="background-color:#c9efcb; line-height:11pt; margin:0pt"><span style="color:#000080; font-family:Consolas; font-size:11pt; font-weight:bold">private</span><span style="font-family:Consolas; font-size:11pt">[scheduler] </span><span style="color:#000080; font-family:Consolas; font-size:11pt; font-weight:bold">def </span><span style="font-family:Consolas; font-size:11pt">handleJobSubmitted(jobId: Int,</span><br /><span style="font-family:Consolas; font-size:11pt">    finalRDD: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">RDD</span><span style="font-family:Consolas; font-size:11pt">[_],</span><br /><span style="font-family:Consolas; font-size:11pt">    func: (</span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">TaskContext</span><span style="font-family:Consolas; font-size:11pt">, </span><span style="color:#20999d; font-family:Consolas; font-size:11pt">Iterator</span><span style="font-family:Consolas; font-size:11pt">[_]) =&gt; _,</span><br /><span style="font-family:Consolas; font-size:11pt">    partitions: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">Array</span><span style="font-family:Consolas; font-size:11pt">[Int],</span><br /><span style="font-family:Consolas; font-size:11pt">    callSite: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">CallSite</span><span style="font-family:Consolas; font-size:11pt">,</span><br /><span style="font-family:Consolas; font-size:11pt">    listener: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt">JobListener</span><span style="font-family:Consolas; font-size:11pt">,</span><br /><span style="font-family:Consolas; font-size:11pt">    properties: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">Properties</span><span style="font-family:Consolas; font-size:11pt">) {</span><br /><span style="font-family:Consolas; font-size:11pt">  </span><span style="color:#000080; font-family:Consolas; font-size:11pt; font-weight:bold">var </span><span style="font-family:Consolas; font-size:11pt">finalStage: </span><span style="color:#e15a61; font-family:Consolas; font-size:11pt; font-weight:bold">ResultStage </span><span style="font-family:Consolas; font-size:11pt">= </span><span style="color:#000080; font-family:Consolas; font-size:11pt; font-weight:bold">null</span><br /><span style="color:#000080; font-family:Consolas; font-size:11pt; font-weight:bold">  try </span><span style="font-family:Consolas; font-size:11pt">{</span><br /><span style="font-family:Consolas; font-size:11pt">    </span><span style="color:#808080; font-family:Consolas; font-size:11pt; font-style:italic">// New stage creation may throw an exception if, for example, jobs are run on a</span><br /><span style="color:#808080; font-family:Consolas; font-size:11pt; font-style:italic">    // HadoopRDD whose underlying HDFS files have been deleted.</span><br /><span style="color:#ff0000; font-family:Consolas; font-size:11pt; font-style:italic">    </span><span style="color:#ff0000; font-family:Consolas; font-size:11pt">finalStage = createResultStage(finalRDD, func, partitions, jobId, callSite)</span><br /><span style="font-family:Consolas; font-size:11pt"> </span><span style="color:#ff0000; font-family:Consolas; font-size:11pt">//</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">…………</span><br /><span style="font-family:宋体; font-size:11pt">  </span><span style="font-family:Consolas; font-size:11pt">listenerBus.post(</span><br /><span style="font-family:Consolas; font-size:11pt">    SparkListenerJobStart(job.jobId, jobSubmissionTime, stageInfos, properties))</span><br /><span style="font-family:Consolas; font-size:11pt"> </span><span style="color:#ff0000; font-family:Consolas; font-size:11pt"> submitStage(finalStage)</span><br /><span style="font-family:Consolas; font-size:11pt">}</span></p></td></tr></table><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.4.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">createResultStage</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">- </span><span style="font-family:宋体; font-size:11pt">根据</span><span style="font-family:等线; font-size:11pt">finalRDD</span><span style="font-family:宋体; font-size:11pt">创建一个总的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">，然后调用</span><span style="font-family:等线; font-size:11pt">sumbitStage</span><span style="font-family:等线; font-size:11pt">(finStage)</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">调用链</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:63pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.006.png" width="610" height="276" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /><span style="font-family:等线; font-size:10.5pt"> </span><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.007.png" width="678" height="149" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">action</span><span style="font-family:宋体; font-size:11pt">触发后，整个</span><span style="font-family:等线; font-size:11pt">job</span><span style="font-family:宋体; font-size:11pt">也就是</span><span style="font-family:宋体; font-size:11pt">整个</span><span style="font-family:等线; font-size:11pt">DAG</span><span style="font-family:宋体; font-size:11pt">算作</span><span style="font-family:宋体; font-size:11pt">一个阶段叫</span><span style="font-family:等线; font-size:11pt">result</span><span style="font-family:等线; font-size:11pt">Stage</span><span style="font-family:宋体; font-size:11pt">，所以总</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">数是</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">shuffleRDD + 1</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">finalRDD</span><span style="font-family:宋体; font-size:11pt">就是最后那个</span><span style="font-family:等线; font-size:11pt">action</span><span style="font-family:宋体; font-size:11pt">算子生成的</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，也就是</span><span style="font-family:等线; font-size:11pt">this</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">分</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">种，</span><span style="font-family:等线; font-size:11pt">resultStage</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">shuffleMapStage</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">resultStage</span><span style="font-family:宋体; font-size:11pt">就是总的</span><span style="font-family:等线; font-size:11pt">job</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">shuffleMapStage</span><span style="font-family:宋体; font-size:11pt">以宽依赖为界划分</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">getOrCreateParentStage</span><span style="font-family:宋体; font-size:11pt">返回值为各个完整的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">list</span><span style="font-family:宋体; font-size:11pt">，然后放回到</span><span style="font-family:等线; font-size:11pt">ResultStage</span><span style="font-family:宋体; font-size:11pt">中，组成最终的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">赋值给</span><span style="font-family:等线; font-size:11pt">finalStage</span><span style="font-family:宋体; font-size:11pt">变量</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{5}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">getShuffleDependencies</span><span style="font-family:等线; font-size:11pt">   </span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.008.png" width="609" height="140" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">一个</span><span style="font-family:等线; font-size:11pt">Dependency</span><span style="font-family:宋体; font-size:11pt">对象就是一个</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">对象</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">此方法的参数是</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">第一次循环</span><span style="font-family:宋体; font-size:11pt">这个</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">就是最后一个</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">，一定是调用了行动算子的</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:宋体; font-size:11pt">此方法的</span><span style="font-family:宋体; font-size:11pt">作用</span><span style="font-family:宋体; font-size:11pt">是获取</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">直接父辈且跟当前</span><span style="color:#ff0000; font-family:等线; font-size:11pt">rdd</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">关系为</span><span style="color:#ff0000; font-family:等线; font-size:11pt">shuffle</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">的依赖</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">因为有</span><span style="font-family:等线; font-size:11pt">shuffle</span><span style="font-family:宋体; font-size:11pt">的直接父辈依赖意味着会划分为不同</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:等线; font-size:11pt"> </span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">toVisit</span><span style="font-family:宋体; font-size:11pt">就是当前</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，放入再</span><span style="font-family:等线; font-size:11pt">pop</span><span style="font-family:宋体; font-size:11pt">应该是配合</span><span style="font-family:等线; font-size:11pt">waitingForVisit</span><span style="font-family:宋体; font-size:11pt">这个队列的名字。</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">查看当前</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:宋体; font-size:11pt">依赖的属性中有没有</span><span style="font-family:等线; font-size:11pt">shuffle</span><span style="font-family:宋体; font-size:11pt">依赖</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:105pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.009.png" width="527" height="361" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:12pt; margin:7.8pt 0pt; text-indent:105pt"><span style="width:21pt; text-indent:0pt; display:inline-block"></span><span style="font-family:等线; font-size:12pt">如果当前RDD</span><span style="font-family:等线; font-size:12pt">的依赖中有</span><span style="font-family:等线; font-size:12pt">shuffle依赖，就添加到parents，如果</span><span style="font-family:等线; font-size:12pt">不是</span><span style="font-family:等线; font-size:12pt">shuffle依赖，就把其父辈的不是shuffle的RDD加入到waitingForVisit中</span></p><p style="line-height:12pt; margin:7.8pt 0pt; text-indent:105pt"><span style="font-family:等线; font-size:12pt">因为是行动算子触发的此方法，所以当前RDD就是DAG中最后一个RDD</span></p><p style="line-height:12pt; margin:7.8pt 0pt; text-indent:105pt"><span style="font-family:等线; font-size:12pt">RDD只有父的概念没有子，所以只能从后往前推，因为DAG是单向的</span></p><p style="line-height:12pt; margin:7.8pt 0pt; text-indent:105pt"><span style="font-family:等线; font-size:12pt">当前WC的例子中，shuffleRDD只有一个，放在了</span><span style="color:#ff0000; font-family:等线; font-size:12pt">parents</span><span style="font-family:等线; font-size:12pt">中，剩下的都放在了waitingForVisit</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">获取到</span><span style="font-family:等线; font-size:11pt">parents</span><span style="font-family:宋体; font-size:11pt">后使用</span><span style="font-family:等线; font-size:11pt">map</span><span style="font-family:宋体; font-size:11pt">修改结构</span><span style="font-family:等线; font-size:11pt">getOrCreateShuffleMapStage</span><span style="font-family:宋体; font-size:11pt">，此方法用来把一个</span><span style="font-family:等线; font-size:11pt">shuffle</span><span style="font-family:宋体; font-size:11pt">依赖转成一个</span><span style="font-family:等线; font-size:11pt">Stage</span><span style="font-family:宋体; font-size:11pt">，因为一个</span><span style="font-family:等线; font-size:11pt">shuffle</span><span style="font-family:宋体; font-size:11pt">依赖意味着要划分一个新的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">，且此时这个</span><span style="font-family:等线; font-size:11pt">shuffle</span><span style="font-family:宋体; font-size:11pt">依赖只有一个</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">，此方法还要根据血缘关系把这个</span><span style="font-family:等线; font-size:11pt">rdd</span><span style="font-family:宋体; font-size:11pt">的血缘关系不全，然后根据这个</span><span style="font-family:等线; font-size:11pt">liniage</span><span style="font-family:宋体; font-size:11pt">转成</span><span style="font-family:等线; font-size:11pt">stage</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:126pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.010.png" width="658" height="378" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:14pt; margin:7.8pt 0pt 7.8pt 105pt; text-indent:21pt"><span style="font-family:等线; font-size:14pt">createShuffleMapStage</span><span style="font-family:等线; font-size:14pt">，会创建一个ShuffleMapStage的对象，这个stage会将之前只有直接父辈依赖的</span><span style="font-family:等线; font-size:14pt">lineage</span><span style="font-family:等线; font-size:14pt">补全，</span><span style="font-family:等线; font-size:14pt">然后创建</span><span style="font-family:等线; font-size:14pt">一个完整的stage</span></p><p style="line-height:14pt; margin:7.8pt 0pt 7.8pt 105pt; text-indent:21pt"><span style="font-family:等线; font-size:14pt">ShuffleMapStage</span><span style="font-family:等线; font-size:14pt">表示这个stage是映射的全是窄依赖的stage，stage本来就只有窄依赖。</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 85.05pt; text-indent:52.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.011.png" width="800" height="129" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{6}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">createResultStage</span><span style="font-family:宋体; font-size:11pt">执行完返回</span><span style="font-family:宋体; font-size:11pt">各个完整的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">list</span><span style="font-family:宋体; font-size:11pt">，然后回放到</span><span style="font-family:等线; font-size:11pt">ResultStage</span><span style="font-family:宋体; font-size:11pt">中，组成最终的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">赋值给</span><span style="font-family:等线; font-size:11pt">finalStage</span><span style="font-family:宋体; font-size:11pt">变量。但此时还有个问题就是最终那个触发行动算子的</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">还没有加进来，要在下面</span><span style="font-family:等线; font-size:11pt">              </span><span style="font-family:等线; font-size:11pt">submitStage</span><span style="font-family:宋体; font-size:11pt">中加</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.4.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">submitStage(finalStage)</span><span style="font-family:等线; font-size:11pt"> - </span><span style="font-family:宋体; font-size:11pt">划分</span><span style="font-family:等线; font-size:11pt">stage</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.012.png" width="780" height="325" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">getMissingParentStages</span><span style="font-family:等线; font-size:11pt"> </span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.013.png" width="585" height="510" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">visit</span><span style="font-family:宋体; font-size:11pt">先不执行，先把</span><span style="font-family:等线; font-size:11pt">finalRDD</span><span style="font-family:宋体; font-size:11pt">放到</span><span style="font-family:等线; font-size:11pt">w</span><span style="font-family:等线; font-size:11pt">FV</span><span style="font-family:宋体; font-size:11pt">中，然后执行</span><span style="font-family:等线; font-size:11pt">visit</span><span style="font-family:宋体; font-size:11pt">，参数为刚压进去的</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，第一次是</span><span style="font-family:等线; font-size:11pt">finalRDD</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">visit</span><span style="font-family:宋体; font-size:11pt">中，先判断参数</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">有没有被访问过，没访问过就放到</span><span style="font-family:等线; font-size:11pt">visit</span><span style="font-family:宋体; font-size:11pt">集合中，然后</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">判断这个</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">的直接依赖</span><span style="font-family:等线; font-size:11pt">(</span><span style="font-family:宋体; font-size:11pt">可以有多个</span><span style="font-family:等线; font-size:11pt">)</span><span style="font-family:宋体; font-size:11pt">为宽</span><span style="font-family:等线; font-size:11pt">(</span><span style="font-family:等线; font-size:11pt">shuffle)</span><span style="font-family:宋体; font-size:11pt">还是窄</span><span style="font-family:等线; font-size:11pt">(narrow</span><span style="font-family:等线; font-size:11pt">)</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">如果是窄，就把依赖的</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">放到栈里，继续递归执行</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》窄依赖会组成一个</span><span style="font-family:等线; font-size:11pt">stage</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">如果是宽，创建一个</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">，然后放到</span><span style="font-family:等线; font-size:11pt">missing</span><span style="font-family:宋体; font-size:11pt">这个</span><span style="font-family:等线; font-size:11pt">hashset</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">missing</span><span style="font-family:宋体; font-size:11pt">只存</span><span style="font-family:等线; font-size:11pt">shuffleStage==</span><span style="font-family:宋体; font-size:11pt">》宽依赖会单独创建</span><span style="font-family:等线; font-size:11pt">stage</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">getOrCreateShuffleMapStage(shufDep, stage.firstJobId)</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">就是创建宽依赖的stage</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[5]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">此时，</span><span style="font-family:等线; font-size:11pt">missing</span><span style="font-family:宋体; font-size:11pt">全都是</span><span style="font-family:等线; font-size:11pt">shuffleMapStage</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">visited</span><span style="font-family:宋体; font-size:11pt">存有全部的</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，表示已经访问过，也就是已经加入到</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">中。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[6]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">最后会把</span><span style="font-family:等线; font-size:11pt">missing</span><span style="font-family:宋体; font-size:11pt">转成</span><span style="font-family:等线; font-size:11pt">list</span><span style="font-family:宋体; font-size:11pt">返回</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[7]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》倒序，遍历直接父</span><span style="font-family:等线; font-size:11pt">RDD</span><span style="font-family:宋体; font-size:11pt">，判断宽窄，分别处理</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">执行完</span><span style="font-family:等线; font-size:11pt">getMissingParentStages</span><span style="font-family:宋体; font-size:11pt">，判断返回的</span><span style="font-family:等线; font-size:11pt">missing</span><span style="font-family:宋体; font-size:11pt">是否为空，也就是判断是否递归到头，如果不为空，说明没遍历完，递归执行</span><span style="font-family:等线; font-size:11pt">submitStage</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">如果不为空，就</span><span style="font-family:等线; font-size:11pt">submitMissingTasks(stage, jobId.get)</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 85.05pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">提交后，根据stage的不同（result或shuffleMap），切分成不同的task，封装成taskset的方式调用</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">TS</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的submitTasks提交</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.014.png" width="765" height="141" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.015.png" width="768" height="142" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">submitMissingTasks</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:84pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.016.png" width="590" height="319" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">判断当前提交的</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">是什么类型，一共就</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">种类型。然后根据类型和分区数创建</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》计算分区</span><span style="font-family:等线; font-size:11pt">partitionsToCompute</span><span style="font-family:宋体; font-size:11pt">返回元素为分区数的</span><span style="font-family:等线; font-size:11pt">RDD</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">map</span><span style="font-family:宋体; font-size:11pt">方法中把分区号映射为</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">，创建</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">的参数包括</span><span style="font-family:等线; font-size:11pt">stageId</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">submitWaitingChildStages(stage)</span><span style="font-family:等线; font-size:11pt">   </span><span style="font-family:宋体; font-size:11pt">提交</span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">是从前往后</span></h5><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.5</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">提交给</span><span style="font-family:等线; font-size:11pt; font-weight:bold">TS</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">后，遍历</span><span style="font-family:等线; font-size:11pt; font-weight:bold">task</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">，发送给</span><span style="font-family:等线; font-size:11pt; font-weight:bold">worker</span><span style="font-family:等线; font-size:11pt; font-weight:bold"> </span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">note</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">stage</span><span style="font-family:宋体; font-size:11pt">也有父子关系</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.5.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">TS</span><span style="font-family:宋体; font-size:11pt">调用</span><span style="font-family:等线; font-size:11pt">driver</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">driverEndpoint</span><span style="font-family:宋体; font-size:11pt">发送</span></h4><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.6</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt; font-weight:bold">executor</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">执行</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.6.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">launchTask</span><span style="font-family:宋体; font-size:11pt">，创建</span><span style="font-family:等线; font-size:11pt">threadpool</span><span style="font-family:宋体; font-size:11pt">，任务池，</span><span style="font-family:等线; font-size:11pt">task</span><span style="font-family:宋体; font-size:11pt">创建好</span><span style="font-family:等线; font-size:11pt">Executor</span><span style="font-family:宋体; font-size:11pt">不一定准备好。</span></h4><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:84pt"><img src="bd1c91ce-4c4b-4777-b3ea-4d5182d049e0.017.png" width="682" height="143" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p></div></body></html>