<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="generator" content="Aspose.Words for .NET 15.1.0.0" /><title></title></head><body><div><h2 style="margin:0pt 0pt 6pt 14.15pt; text-indent:0pt"><span style="font-family:等线; font-size:14pt; font-style:normal">1.</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">集群启动源码分析</span></h2><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">分为</span><span style="font-family:等线; font-size:11pt; font-weight:bold">master</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">和</span><span style="font-family:等线; font-size:11pt; font-weight:bold">worker</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的启动，</span><span style="font-family:宋体; font-size:11pt; font-weight:bold"> </span><span style="font-family:等线; font-size:11pt; font-weight:bold">2</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">者启动流程差不多，读懂一个即可。集群启动主要就是通信环境的建立</span><span style="font-family:等线; font-size:11pt; font-weight:bold">(</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">接收消息，处理消息</span><span style="font-family:等线; font-size:11pt; font-weight:bold">)</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">和</span><span style="font-family:等线; font-size:11pt; font-weight:bold">master</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">、</span><span style="font-family:等线; font-size:11pt; font-weight:bold">worker</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">的注册。</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">spark</span><span style="font-family:宋体; font-size:11pt">是分布式的，想要协调执行，必然要通信，</span><span style="font-family:等线; font-size:11pt">spark</span><span style="font-family:宋体; font-size:11pt">使用了</span><span style="font-family:等线; font-size:11pt">netty</span><span style="font-family:宋体; font-size:11pt">框架通信。使用</span><span style="font-family:等线; font-size:11pt">RPCEnv</span><span style="font-family:宋体; font-size:11pt">对象来抽象，启动</span><span style="font-family:等线; font-size:11pt">master</span><span style="font-family:宋体; font-size:11pt">就会创建</span><span style="font-family:等线; font-size:11pt">RPCEnv</span><span style="font-family:宋体; font-size:11pt">上下文对象。各个角色都通过</span><span style="font-family:等线; font-size:11pt">RPCEnv</span><span style="font-family:宋体; font-size:11pt">来通信，相当于</span><span style="font-family:等线; font-size:11pt">web</span><span style="font-family:宋体; font-size:11pt">中的</span><span style="font-family:等线; font-size:11pt">session</span><span style="font-family:宋体; font-size:11pt">作用域。角色通信的方式类似于发邮件。</span></h4><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">通信环境可以理解为一个工具类，每个角色都会创建。</span></h4><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">用文字描述的方式很难读，还不如直接打开</span><span style="font-family:等线; font-size:11pt; font-weight:bold">IDE</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">把代码复制出来然后写注释呢。所以这里用图画的形式描述</span></h3><h4 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">通信角色，每个角色在通信环境中抽象为各自的</span><span style="font-family:等线; font-size:11pt">EndPoint</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Master</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Worker</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Driver</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Application</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{5}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">Executor</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">process</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">执行</span><span style="font-family:等线; font-size:11pt">start-all.sh</span><span style="font-family:宋体; font-size:11pt">后，先执行</span><span style="font-family:等线; font-size:11pt">start-master.sh</span><span style="font-family:宋体; font-size:11pt">，调用</span><span style="font-family:等线; font-size:11pt">Master</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">main</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建</span><span style="font-family:等线; font-size:11pt">nettyEnv</span><span style="font-family:宋体; font-size:11pt">，这个对象有</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">个重要的属性，</span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">transportContext</span><span style="font-family:宋体; font-size:11pt">，</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">用来接收消息，根据消息的中目的地的</span><span style="font-family:等线; font-size:11pt">name</span><span style="font-family:宋体; font-size:11pt">调用对应</span><span style="font-family:等线; font-size:11pt">name</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">EndPointData</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">inbox</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">process</span><span style="font-family:宋体; font-size:11pt">来处理。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">transportContext</span><span style="font-family:宋体; font-size:11pt">用来提供创建</span><span style="font-family:等线; font-size:11pt">server</span><span style="font-family:宋体; font-size:11pt">和设置通信管道的配置</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">有了</span><span style="font-family:等线; font-size:11pt">nerryEnv</span><span style="font-family:宋体; font-size:11pt">，就可以根据套接字创建</span><span style="font-family:等线; font-size:11pt">server</span><span style="font-family:宋体; font-size:11pt">，接收角色的注册，创建各自对应的</span><span style="font-family:等线; font-size:11pt">EndPointData</span><span style="font-family:宋体; font-size:11pt">。提供服务。</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:52.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.001.jpeg" width="906" height="889" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h3 style="margin:0pt 0pt 6pt 28.35pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">文字描述：</span><span style="font-family:等线; font-size:11pt; font-weight:bold">start-all</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">脚本里面调用了</span><span style="font-family:等线; font-size:11pt; font-weight:bold">start-master</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">和</span><span style="font-family:等线; font-size:11pt; font-weight:bold">start-slaves</span><span style="font-family:等线; font-size:11pt; font-weight:bold">.sh</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">脚本，</span><span style="font-family:等线; font-size:11pt; font-weight:bold">start-master.</span><span style="font-family:等线; font-size:11pt; font-weight:bold">sh</span><span style="font-family:宋体; font-size:11pt; font-weight:bold">主要功能就是通信环境搭建</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">start-master</span><span style="font-family:等线; font-size:11pt">.sh</span><span style="font-family:宋体; font-size:11pt">里面调用了</span><span style="font-family:等线; font-size:11pt">Master</span><span style="font-family:宋体; font-size:11pt">类，里面有</span><span style="font-family:等线; font-size:11pt">main</span><span style="font-family:宋体; font-size:11pt">方法</span><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.002.png" width="486" height="38" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">startRpcEnvAndEndpoint(args.host, args.port, args.webUiPort, conf)</span><span style="font-family:等线; font-size:11pt">  </span><span style="font-family:宋体; font-size:11pt">此方法用来创建通用的</span><span style="font-family:等线; font-size:11pt">EndPoint</span><span style="font-family:宋体; font-size:11pt">和搭建通信环境</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">里面调用链为</span><span style="font-family:等线; font-size:11pt">RpcEnv.create</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">-</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">new NettyRpcEnvFactory().create(config)</span><span style="font-family:等线; font-size:11pt"> </span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.003.png" width="655" height="121" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.004.png" width="660" height="309" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.005.png" width="729" height="219" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">create</span><span style="font-family:宋体; font-size:11pt">中</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">创建了</span><span style="font-family:等线; font-size:11pt">sparkConf</span><span style="font-family:宋体; font-size:11pt">对象，然后</span><span style="font-family:等线; font-size:11pt">new</span><span style="font-family:宋体; font-size:11pt">了</span><span style="font-family:等线; font-size:11pt">NettyRpcEnv</span><span style="font-family:宋体; font-size:11pt">对象，</span><span style="font-family:等线; font-size:11pt">new</span><span style="font-family:宋体; font-size:11pt">一个类时，除了里面的方法别的都执行</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.006.png" width="682" height="355" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">NettyRpcEnv</span><span style="font-family:宋体; font-size:11pt">，里面会有</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">个重要的对象</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.007.png" width="639" height="134" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><span style="font-family:等线; font-size:10.5pt">，</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{5}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">用来把接收的消息分发给各角色注册的</span><span style="font-family:等线; font-size:11pt">EndPoint</span><span style="font-family:宋体; font-size:11pt">，也就是接收消息，然后交给</span><span style="font-family:等线; font-size:11pt">inbox</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">process</span><span style="font-family:宋体; font-size:11pt">去处理转发</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">会创建一个线程池，接到消息就启动一个线程</span><span style="font-family:等线; font-size:11pt">MessageLoop</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">MessageLoop</span><span style="font-family:宋体; font-size:11pt">有个死循环，会一直监听对应端口是否接收到消息。类似于聊天室的思路，转发消息</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.008.png" width="698" height="176" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">receivers</span><span style="font-family:宋体; font-size:11pt">是个队列，如果里面有数据，就会调用</span><span style="font-family:等线; font-size:11pt">EndpointData</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">inbox</span><span style="font-family:宋体; font-size:11pt">对象的</span><span style="font-family:等线; font-size:11pt">process</span><span style="font-family:宋体; font-size:11pt">去处理这个消息</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.009.png" width="569" height="61" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.010.png" width="573" height="406" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">EndpointData</span><span style="font-family:宋体; font-size:11pt">用来封装数据</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.011.png" width="358" height="132" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:6pt 0pt 6pt 73.5pt; text-indent:21pt"><span style="font-family:等线; font-size:11pt">{6}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">TransportContext</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">用来创建</span><span style="font-family:等线; font-size:11pt">server</span><span style="font-family:宋体; font-size:11pt">处理消息。需要</span><span style="font-family:等线; font-size:11pt">nettyRpcHandler</span><span style="font-family:宋体; font-size:11pt">作为参数</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 73.5pt; text-indent:21pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.012.png" width="634" height="51" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{7}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">创建完</span><span style="font-family:等线; font-size:11pt">NettyRpcEnv</span><span style="font-family:宋体; font-size:11pt">对象，封装好</span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">transportContext</span><span style="font-family:宋体; font-size:11pt">对象，</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">执行</span><span style="font-family:等线; font-size:11pt">startServer</span><span style="font-family:宋体; font-size:11pt">，会启动</span><span style="font-family:等线; font-size:11pt">RPC</span><span style="font-family:宋体; font-size:11pt">服务，调用已经创建的</span><span style="font-family:等线; font-size:11pt">TransportContext</span><span style="font-family:宋体; font-size:11pt">创建</span><span style="font-family:等线; font-size:11pt">server</span><span style="font-family:宋体; font-size:11pt">，启动</span><span style="font-family:等线; font-size:11pt">netty</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">调用</span><span style="font-family:等线; font-size:11pt">Utils.startServiceOnPort</span><span style="font-family:宋体; font-size:11pt">，就会执行</span><span style="font-family:等线; font-size:11pt">startNettyRpcEnv</span><span style="font-family:宋体; font-size:11pt">，就会调用</span><span style="font-family:等线; font-size:11pt">nettyEnv.startServer</span><span style="font-family:宋体; font-size:11pt">来启动</span><span style="font-family:等线; font-size:11pt">RPC</span><span style="font-family:宋体; font-size:11pt">服务，往里一直跟到</span><span style="font-family:等线; font-size:11pt">TransportServer</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.013.png" width="662" height="312" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.014.png" width="650" height="201" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.015.png" width="756" height="122" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.016.png" width="715" height="344" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">new</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">TransportServer</span><span style="font-family:宋体; font-size:11pt">会执行</span><span style="font-family:等线; font-size:11pt">init</span><span style="font-family:宋体; font-size:11pt">方法，创建管道，然后初始化处理消息的</span><span style="font-family:等线; font-size:11pt">hander</span><span style="font-family:宋体; font-size:11pt">，用来处理消息。消息分为请求的和响应的，分别用</span><span style="font-family:等线; font-size:11pt">requestHandler</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">responseHandler</span><span style="font-family:宋体; font-size:11pt">来处理，然后统一封装到</span><span style="font-family:等线; font-size:11pt">TransportChannelHandler</span><span style="font-family:宋体; font-size:11pt">中</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.017.png" width="532" height="195" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.018.png" width="799" height="159" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.019.png" width="754" height="246" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">创建完</span><span style="font-family:等线; font-size:11pt">TransportChannelHandler</span><span style="font-family:宋体; font-size:11pt">，意味着</span><span style="font-family:等线; font-size:11pt">server</span><span style="font-family:宋体; font-size:11pt">已经启动，处理消息的处理也已经创建并初始化完毕，前面接收消息的</span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">已经创建好。意味着通信环境已经搭建好</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.85pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">搭建完环境，接收到消息，就会由</span><span style="font-family:等线; font-size:11pt">dispatcher</span><span style="font-family:宋体; font-size:11pt">分发，然后由</span><span style="font-family:等线; font-size:11pt">TransportChannelHandler</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">channelRead</span><span style="font-family:宋体; font-size:11pt">来处理。</span><span style="font-family:等线; font-size:11pt">channelRead</span><span style="font-family:宋体; font-size:11pt">会判断是请求还是响应消息，然后分别由对应</span><span style="font-family:等线; font-size:11pt">handler</span><span style="font-family:宋体; font-size:11pt">处理</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:94.5pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.020.png" width="640" height="186" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{8}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">搭建完环境，</span><span style="font-family:等线; font-size:11pt">main</span><span style="font-family:宋体; font-size:11pt">中最后会把</span><span style="font-family:等线; font-size:11pt">master</span><span style="font-family:宋体; font-size:11pt">注册到</span><span style="font-family:等线; font-size:11pt">rpcEnv</span><span style="font-family:宋体; font-size:11pt">中，然后启动</span><span style="font-family:等线; font-size:11pt">master</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:84pt"><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.021.png" width="606" height="255" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 42.55pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.3.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">start-slaves</span><span style="font-family:等线; font-size:11pt">.sh</span><span style="font-family:宋体; font-size:11pt">里面会连接每个节点，启动每个节点的</span><span style="font-family:等线; font-size:11pt">start-slave.sh</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:等线; font-size:11pt">start-slave.sh</span><span style="font-family:宋体; font-size:11pt">里也会启动一个主类。</span><span style="font-family:等线; font-size:11pt">org.apache.worker.Worker</span><span style="font-family:等线; font-size:11pt"> </span><img src="7c7238d0-af97-448b-bcf7-4dd86999eaa1.022.png" width="467" height="36" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></h4><p style="line-height:10.5pt; margin:7.8pt 0pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p></div></body></html>