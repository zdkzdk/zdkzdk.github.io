<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="generator" content="Aspose.Words for .NET 15.1.0.0" /><title></title></head><body><div><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 34.95pt"><span style="font-family:等线; font-size:10.5pt">h</span><span style="font-family:等线; font-size:10.5pt">dfs</span><span style="font-family:等线; font-size:10.5pt">最重要的2个原理，存储原理和读写流程。网上的往往都不全，自己把网上各个说法整合了一下</span></p><h3 style="margin:0pt 0pt 6pt 34.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">存储原理</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">src</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">均匀线性切分为块</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">块大小的设置，为什么默认为</span><span style="font-family:等线; font-size:11pt">128M</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">冗余数据保存</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">副本放置策略</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><a name="_Hlk25619685"><span style="font-family:宋体; font-size:11pt">数据错误与恢复</span></a></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">数据完整性</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">通过</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">进行管理，</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">上存储</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">中块的元数据，使用</span><span style="font-family:等线; font-size:11pt">SNN</span><span style="font-family:宋体; font-size:11pt">或主从模型进行了</span><span style="font-family:等线; font-size:11pt">HA</span><span style="font-family:宋体; font-size:11pt">处理。</span><span style="font-family:等线; font-size:11pt">SNN</span><span style="font-family:宋体; font-size:11pt">是依靠冷备份，主从模型依靠实时的内存状态的同步。</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{5}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">一次写入，多次读取，不能修改，可以追加</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 56.7pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{6}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">流式访问</span></h5><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><a name="_Hlk25619662"><span style="font-family:宋体; font-size:11pt">块</span></a></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">src</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">一个文件被分成多个块，以块作为存储单位</span><span style="font-family:宋体; font-size:11pt">。文件线性均匀切割成块分散在各个节点</span><span style="font-family:等线; font-size:11pt">(Block</span><span style="font-family:等线; font-size:11pt">)</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">采用抽象的</span><span style="font-family:宋体; font-size:11pt">块概念</span><span style="font-family:宋体; font-size:11pt">可以带来以下几个明显的好处：</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt; font-weight:bold">支持大规模文件存储</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">：文件以块为单位进行存储，一个大规模文件可以被分拆成若干个文件块，不同的文件块可以被分发到不同的节点上，因此，一个文件的大小不会受到单个节点的存储容量的限制，可以远远大于网络中任意节点的存储容量</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt; font-weight:bold">简化系统设计</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">：首先，大大简化了存储管理，因为文件块大小是固定的，这样就可以很容易计算出一个节点可以存储多少文件块；其次，方便了元数据的管理，元数据不需要和文件块一起存储，可以由其他系统负责管理元数据</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(3)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt; font-weight:bold">适合数据备份</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">：每个文件块都可以冗余存储到多个节点上，大大提高了系统的容错性和可用性</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">寻址</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">找到块的起始位置，也就是偏移量指示的地方。</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">块的大小</span><span style="font-family:宋体; font-size:11pt"> </span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">这个问题在</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">Google </span><span style="font-family:宋体; font-size:11pt">的论文《</span><span style="font-family:等线; font-size:11pt">GFS</span><span style="font-family:宋体; font-size:11pt">》有提到。</span><span style="font-family:等线; font-size:11pt">5400 </span><span style="font-family:宋体; font-size:11pt">转硬盘平均读写理论上在</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">60-90MB/s</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">7200 </span><span style="font-family:宋体; font-size:11pt">转大致在</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">130-190MB/s</span><span style="font-family:宋体; font-size:11pt">；</span><span style="font-family:宋体; font-size:11pt">数据写磁盘是需要消耗寻址时间的，最优的理论情况是寻址时间仅占传输时间的</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">1%</span><span style="font-family:宋体; font-size:11pt">，</span><span style="color:#ff0000; font-family:等线; font-size:11pt">HDFS</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">中平均寻址时间</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">是固定的</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">大概为</span><span style="color:#ff0000; font-family:等线; font-size:11pt">10ms</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">为了</span><span style="font-family:宋体; font-size:11pt">降低寻址开销，最优情况当然是一次寻址写完这次传输的所有数据。</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">如果一次寻址传不完，还是再寻一次</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">主要取决于磁盘IO速度</span></p><p style="font-weight:normal; line-height:14pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:14pt">(2)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">如果设置过小==</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">》</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">块变多，</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">定位一个块</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">寻址</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">时间变多</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">，IO操作变多。</span></p><p style="font-weight:normal; line-height:14pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:14pt">(3)</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">过大==</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">》</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:14pt">磁盘IO时间跟寻址时间不成比例，</span></p><h6 style="font-weight:normal; margin:6pt 0pt 6pt 70.9pt; text-indent:0pt"><span style="color:#ff0000; font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">默认一个块</span><span style="font-family:等线; font-size:11pt">64</span><span style="font-family:等线; font-size:11pt">/128</span><span style="font-family:等线; font-size:11pt">/256</span><span style="font-family:等线; font-size:11pt">MB</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">可以通过</span><span style="font-family:等线; font-size:11pt">dfs.bloclsize</span><span style="font-family:宋体; font-size:11pt">设置。</span><span style="font-family:宋体; font-size:11pt">块的大小远远大于普通文件系统</span><span style="font-family:宋体; font-size:11pt">的扇区</span><span style="font-family:等线; font-size:11pt">(</span><span style="font-family:等线; font-size:11pt">512k)</span><span style="font-family:宋体; font-size:11pt">，</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">可以最小化寻址开销</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">，减少寻址的次数</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">单一文件</span><span style="font-family:等线; font-size:11pt">Block</span><span style="font-family:宋体; font-size:11pt">除了最后一个大小一致，如果最后一个块的字节</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">小于</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">设定值，也会占用一个逻辑上的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">，切片时也会对应一个</span><span style="font-family:等线; font-size:11pt">split</span><span style="font-family:宋体; font-size:11pt">，也会开一个</span><span style="font-family:等线; font-size:11pt">map</span><span style="font-family:宋体; font-size:11pt">来处理，但不会占用</span><span style="font-family:等线; font-size:11pt">blockSize</span><span style="font-family:宋体; font-size:11pt">的空间</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">不同文件的block的大小可以不一致。一个文件对应一个blockSize，一个文件只能设置一个blockSize</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">分block时，1.x版本默认64M，2.x默认128M，是因为计算机硬盘的I/O速度提高了.</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">切块</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">client</span><span style="font-family:宋体; font-size:11pt">切，在</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">获取到</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">位置后上传到指定</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">存</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">文件在计算机存储时，本质都是二进制的字节数组，切割的时候，也都是以字节为单位进行切割</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">==</span><span style="font-family:宋体; font-size:11pt">》</span><span style="font-family:宋体; font-size:11pt">一个文件以字节数组的方式分散在各个节点</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">实际场景下一个文件一般不会不经过切割直接存在一个节点中，而是切割为不同的部分散列到集群节点中，而且每个部分长度相同，集群的节点</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">存块成功</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">后要向管理节点汇报</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">偏移量</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:等线; font-size:11pt">(byte)</span><span style="font-family:宋体; font-size:11pt">：块用偏移量来描述。块的第一个字节面向源文件的下标，源文件和块是由多个字节组成的，如果把源文件看成一个字节数组，</span><span style="font-family:等线; font-size:11pt">offset</span><span style="font-family:宋体; font-size:11pt">就是</span><span style="font-family:宋体; font-size:11pt">当前块</span><span style="font-family:宋体; font-size:11pt">的第一个字节</span><span style="font-family:等线; font-size:11pt">(</span><span style="font-family:宋体; font-size:11pt">下标最小的字节</span><span style="font-family:等线; font-size:11pt">)</span><span style="font-family:宋体; font-size:11pt">在未分割时在源文件的字节数组中的下标。</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">就是</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">当前块</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">字节数组的起始元素在源文件字节数组中的下标</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">比如第一个块的offset就是0，因为第一个块的字节数组的第一个字节在源文件的字节数组的下标就是0</span></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.3</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">副本</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">可靠性：块分散在不同的节点，如果其中某个节点</span><span style="font-family:宋体; font-size:11pt">宕</span><span style="font-family:宋体; font-size:11pt">了，会造成文件不完整。可以在上传时将一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">复制多份存在多个节点上，这样其中一个挂了，别的节点可以补上</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">副本数：</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">中每个节点存的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的数量可能不同，如下图</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="a92f7a29-4754-491c-96a4-eb50876697cf.001.png" width="524" height="335" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">副本分散在不同节点中，出现在同一个节点或同一个机架没意义</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:Wingdings; font-size:11pt"></span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">副本数不要超过节点数量</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">副本很浪费空间，1T的数据，副本设置为2，就要用2T来存</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">但后期使用计算框架时，可以会设的很高，</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">因为一个</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">block</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">可能有多个程序要使用</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">，为了让程序避免出现等待和争抢的情况，会把副本调高。</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">副本数是包括主节点上的</span><span style="font-family:等线; font-size:11pt">(es</span><span style="font-family:宋体; font-size:11pt">的副本和</span><span style="font-family:宋体; font-size:11pt">源分开</span><span style="font-family:宋体; font-size:11pt">计数</span><span style="font-family:等线; font-size:11pt">)</span><span style="font-family:宋体; font-size:11pt">，因为</span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">主是不存的。也就是说，一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的副本数就是一共有多少个节点</span><span style="font-family:宋体; font-size:11pt">存这个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="color:#ff0000; font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:宋体; font-size:11pt">已上传的文件的</span><span style="color:#ff0000; font-family:等线; font-size:11pt">block</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">副本数可以调整，但</span><span style="color:#ff0000; font-family:等线; font-size:11pt">block</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">的大小不可变，也不能修改里面的数据但可以</span><span style="color:#ff0000; font-family:等线; font-size:11pt">append</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">追加。</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">因为只要修改了一个block，这个block的长度就变了，整个文件的长度也变了，所有block的offset也就变了。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">其实也可以做成可修改的，其余的block</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">跟修改</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的block配合一下即可。但这样会极大的增加系统的负荷，因为会出现多台服务器并行修改的情况，需要同步，需要修改元数据。</span><span style="color:#1f3864; font-family:Wingdings; font-size:11pt"></span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">取消修改的功能，存储层就不会消耗大量的性能。</span><span style="color:#1f3864; font-family:Wingdings; font-size:11pt"></span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">一次写入，多次读取 </span><span style="color:#1f3864; font-family:Wingdings; font-size:11pt"></span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">为什么有了很多文件系统还要单独开发hdfs？hdfs是为了为分布式计算服务，就是为了能更好的支撑分布式计算，不是仅仅为了存文件。</span></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.4</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="-aw-bookmark-end:_Hlk25619662"></span><span style="font-family:宋体; font-size:11pt">冗余数据保存</span><span style="font-family:宋体; font-size:11pt">机制、副本机制</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">src</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">部署在廉价机器上，出故障是常态</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">不是散列策略</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:63pt"><img src="a92f7a29-4754-491c-96a4-eb50876697cf.002.png" width="404" height="233" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">feature</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">加快数据传输速度</span><span style="font-family:宋体; font-size:11pt">，流数据处理机制</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">自动</span><span style="font-family:等线; font-size:11pt">LB</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">容易检查数据错误</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">保证数据可靠性</span><span style="font-family:宋体; font-size:11pt">，自动维持副本数量</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">副本放置策略</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">低版本的</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">副本节点选择</span></h6><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:12pt">默认副本数为3：</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:12pt">第一个备份放在客户端相同的datanode上(若客户端在集群外运行,就随机选取一个datanode来存放第一个replica),</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:12pt">第二个replica放在与第一个replica不同机架的一个随机datanode上,</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:12pt">第三个replica放在与第二个replica相同机架的随机datanode上,</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:12pt">如果replica数大于三,则随后的replica在集群中随机存放,Hadoop会尽量避免过多的replica存放在同一个机架上.</span><span style="font-family:等线; font-size:12pt">选取</span><span style="font-family:等线; font-size:12pt">replica存放在同一个机架上.(Hadoop 1.x以后允许replica是可插拔的,意思是说可以定制自己需要的replica分配策略)</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">2.7.2</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">副本节点选择</span></h6><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt"><span style="font-family:等线; font-size:12pt">第一个备份放在客户端相同的</span><span style="font-family:等线; font-size:12pt">datanode上(若客户端在集群外运行,就随机选取一个datanode来存放第一个replica),</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt"><span style="font-family:等线; font-size:12pt">第二个replica和第一个位于相同机架的随机节点</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt"><span style="font-family:等线; font-size:12pt">第三个位于</span><span style="font-family:等线; font-size:12pt">和第二个</span><span style="font-family:等线; font-size:12pt">不同rack的随机节点</span></p><p style="line-height:12pt; margin:7.8pt 0pt 7.8pt 84pt"><span style="font-family:等线; font-size:12pt">因为低版本第二个要跨rack传输，可靠性低</span></p><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.1.5</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">数据完整性</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">完整性主要体现在</span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">读取数据完整性、写数据完整性、还有磁盘完整性</span></h5><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">如何保证？</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">客户端写数据的时候</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">会为每一个固定长度（默认是</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">512字节）的数据执行一次“校验和”，“</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">checksum</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">”的值和数据一起保存起来。就是说一份数据假如5000字节，他会给512字节计算一个校验码，得到5000/512个校验码。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">存之前</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">计算一次checksum，然后</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">将数据和校验和发送到一系列由</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">datanode组成的管线，管线中的最后一个datanode负责校验校验和，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">存之后</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">再计算一个checksum，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果发现</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">2个</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">数据校验和对不上，则抛出异常，hdfs会进行处理，例如重试这个操作。</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">读数据时会验证校验和</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">把读出来的数据和读出来的校验和校验，确保读出的数据是正确的，每个</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">datanode都保持着一个用于验证的校验和日志，日志中保存着每个数据块的验证时间，客户端每验证完一个数据块，就会更新日志。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果在读取数据的过程中，如果检测到数据校验错误，首先会通知</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">namenode这个已损坏数据块以及正在读取的datanode，再抛出ChecksumException异常。namenode将这个数据块副本标记为已损坏，不再将客户端请求发送到这datanode上，并且会把这个数据块的一个副本复制到另一个datanode上，这样数据块的副本因子又可以变成期望水平，默认为3，最后已损坏的数据块会被删除</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">磁盘完整性</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">datanode也会在后台线程中运行一个</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">DataBlockScanner</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">线程定期检查datanode上的所有数据块，避免磁盘损坏。</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">定期对存储在其上面的block进行检测“检验和”，然后将检测结果向NameNode报告。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">为了提高系统性能，避免数据节点在启动后对还没有过期的</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">数据块又扫描</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">一遍，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">DataBlockScanner在其内部使用了日志记录器来持久化保存每一个数据块上一次的扫描时间，这样数据节点可以在启动之后通过日志文件来恢复之前所有的数据块的有效时间。</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">如果一个</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">坏了，</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">如何处理？</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">客户端在发现</span><span style="font-family:宋体; font-size:11pt">坏数据</span><span style="font-family:宋体; font-size:11pt">后，会把坏的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">所在的</span><span style="font-family:等线; font-size:11pt">datanode</span><span style="font-family:宋体; font-size:11pt">报告给</span><span style="font-family:等线; font-size:11pt">namenode</span><span style="font-family:宋体; font-size:11pt">；</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">NameNode</span><span style="font-family:宋体; font-size:11pt">会把这个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">标记为</span><span style="font-family:等线; font-size:11pt">“</span><span style="font-family:宋体; font-size:11pt">已损坏</span><span style="font-family:等线; font-size:11pt">”</span><span style="font-family:宋体; font-size:11pt">，标记为</span><span style="font-family:等线; font-size:11pt">“</span><span style="font-family:宋体; font-size:11pt">已损坏</span><span style="font-family:等线; font-size:11pt">”namenode</span><span style="font-family:宋体; font-size:11pt">就不会为客户端指向这个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">，也不会用这个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">去复制到其他</span><span style="font-family:等线; font-size:11pt">datanode</span><span style="font-family:宋体; font-size:11pt">；</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">NameNode</span><span style="font-family:宋体; font-size:11pt">会把一个好的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">复制到另一个</span><span style="font-family:等线; font-size:11pt">datanode</span><span style="font-family:宋体; font-size:11pt">上；</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">NameNode</span><span style="font-family:宋体; font-size:11pt">删除掉坏的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h3 style="margin:0pt 0pt 6pt 34.95pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt; font-style:normal">1.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt; font-weight:bold">读写流程</span></h3><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.1</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">读流程</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">src</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">读比写</span><span style="font-family:宋体; font-size:11pt">简单但更重要，因为计算框架用的就是读，写</span><span style="font-family:宋体; font-size:11pt">跟计算</span><span style="font-family:宋体; font-size:11pt">没关系</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">不仅是</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">可以向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">申请下载，计算框架也可以</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">process</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:63pt"><img src="a92f7a29-4754-491c-96a4-eb50876697cf.003.png" width="989" height="629" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">open</span><span style="font-family:宋体; font-size:11pt">文件，建立同</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">的连接，返回输入流对象。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">通过输入流对象向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">请求文件的块列表。如果文件很大，信息可能会分多次返回，一次返回一部分块的信息，不是一个块，而是一部分块。信息包括块的偏移量</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">+</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">所有保存该</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">的按与客户端节点网络拓扑距离远近排序的列表</span><span style="font-family:等线; font-size:11pt">(</span><span style="font-family:宋体; font-size:11pt">因为有可能读失败，所以要多返回几个备用</span><span style="font-family:等线; font-size:11pt">)</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">HC通过RPC调用NN的方法获取块信息</span></p><p style="font-weight:normal; line-height:11pt; margin:6pt 0pt 6pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">就近，如何</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">找最近</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的？通过对比HC和DN的机架ID来</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">找最近</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的，找不到就随机</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">1st</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">HDFS提供了一个API可以确定一个数据节点所属的机架ID，客户端可以调用</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">这个</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">API获取自己所属的机架ID</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">2nd</span><span style="font:7.0pt 'Times New Roman'">&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">当客户端读取数据时，从名称节点获得数据块不同副本的存放位置列表，列表中包含了副本所在的数据节点，可以调用</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">API来确定客户端和这些数据节点所属的机架ID，当发现某个数据块副本对应的机架ID和客户端对应的机架ID相同时，就优先选择该副本读取数据，如果没有发现，</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">按远近顺序选择下载的节点</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">获取部</span><span style="font-family:宋体; font-size:11pt">分块的副本节点信息列表后，按顺序选择一个节点下载块</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">根据</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">当前块</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的副本节点的排序列表，选择最近的节点下载，如果中途中断，会自动切换节点</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:宋体; font-size:11pt">下载以</span><span style="color:#ff0000; font-family:等线; font-size:11pt">block</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">为单位，整个流程以</span><span style="color:#ff0000; font-family:等线; font-size:11pt">block</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">为单位不断循环，一个块下载完关闭流，继续根据块列表下载下一个块</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:宋体; font-size:11pt">如果</span><span style="font-family:宋体; font-size:11pt">前一次返回的</span><span style="font-family:宋体; font-size:11pt">块信息</span><span style="font-family:宋体; font-size:11pt">列表不完整</span><span style="font-family:宋体; font-size:11pt">，会继续向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">发送请求获取剩下的文件信息然后继续下载。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[5]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">全部下载完后</span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">完成拼接</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">比如hdfs</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">shell</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的type命令就可以完成合并</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">问题</span><span style="font-family:等线; font-size:11pt">1</span><span style="font-family:宋体; font-size:11pt">：块有副本，要下最近的，就近原则，这里的距离是指节点距离，要根据</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">网络拓扑</span><span style="font-family:宋体; font-size:11pt">判断。</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">只有文件系统中读流程设置了距离优先，计算层才能被动实现计算向数据移动</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">一个block有2个副本，放在2个节点上，节点1上的计算肯定要优先使用节点1的数据</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">请求位置信息时，</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">会根据</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">位置信息和</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:宋体; font-size:11pt">位置信息对</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">进行一个适宜的排序，会返回按距离排好序的列表，</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">根据这个列表</span><span style="font-family:宋体; font-size:11pt">再计算比较一次机架</span><span style="font-family:等线; font-size:11pt">ID</span><span style="font-family:宋体; font-size:11pt">来</span><span style="font-family:宋体; font-size:11pt">确定下载</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">，从本机的</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">下载也叫下载，叫本地化读取。</span></h6><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{4}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">问题</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">：只下载部分块，下载的本质就是</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">向具体的</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">要数据。</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">具有对文件任意位置以</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">为单位单独下载的能力。</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">java</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">IO</span><span style="font-family:宋体; font-size:11pt">流也可以实现执行读取字节数组的区间：</span><span style="font-family:等线; font-size:11pt">RandomAccess</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">此时可以使用偏移量来标识</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">分布式计算一般都是一个计算只针对一个块，不会针对整个文件</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">节省</span><span style="font-family:等线; font-size:11pt">IO</span></h6><h4 style="font-weight:normal; margin:0pt 0pt 6pt 49.15pt; text-indent:0pt"><span style="display:inline; font-family:等线; font-size:11pt; font-style:normal; font-variant:normal; text-decoration:none; text-transform:none; vertical-align:baseline">1.2.2</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">写流程</span></h4><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{1}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">note</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">所谓写，就是上传</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HDFS</span><span style="font-family:宋体; font-size:11pt">中的</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">、</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">、</span><span style="font-family:等线; font-size:11pt">chunk</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">block </span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 85.05pt"><span style="font-family:等线; font-size:10.5pt">文件</span><span style="font-family:等线; font-size:10.5pt">上传前在</span><span style="font-family:等线; font-size:10.5pt">HC分块</span><span style="font-family:等线; font-size:10.5pt">block，一般为128MB，可以改。因为块太小：寻址时间占比过高。块太大：Map任务数太少，作业执行速度变慢。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">packet </span></p><p style="line-height:10.5pt; margin:7.8pt 0pt 7.8pt 63pt; text-indent:21pt"><span style="font-family:等线; font-size:10.5pt">packet是第二大的单位，它是client端向DataNode，或PipLine的DataNode之间传数据的基本单位，默认64KB。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(3)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">chunk </span></p><p style="line-height:11pt; margin:7.8pt 0pt 7.8pt 81.4pt; text-indent:14.2pt"><span style="font-family:等线; font-size:11pt">chunk是最小的单位，它是client向DataNode，或PipLine</span><span style="font-family:等线; font-size:11pt">的</span><span style="font-family:等线; font-size:11pt">DataNode之间进行数据校验的基本单位，默认512Byte，因为</span><span style="font-family:等线; font-size:11pt">以chunk为</span><span style="font-family:等线; font-size:11pt">校验</span><span style="font-family:等线; font-size:11pt">单位</span><span style="font-family:等线; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">故每个</span><span style="font-family:等线; font-size:11pt">chunk需要带有4Byte的校验位。所以实际每个chunk写入packet的大小为516Byte。由此可见真实数据与校验值数据的比值约为128 : 1。（即</span><span style="font-family:等线; font-size:11pt">512/4</span><span style="font-family:等线; font-size:11pt">）</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{2}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">process</span></h5><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:73.5pt"><img src="a92f7a29-4754-491c-96a4-eb50876697cf.004.png" width="815" height="544" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">note</span></h6><p style="font-weight:normal; line-height:12pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:12pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:12pt">输入流是open，输出流是create</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:12pt">()</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:12pt">，由fs对象调用</span></p><p style="font-weight:normal; line-height:12pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:12pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:12pt">数据packet在所有DN全部存储成功之后才会返回ack确认包，最终返回给FSDOS</span></p><p style="font-weight:normal; line-height:12pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:12pt">(3)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:12pt">FileSystem是抽象类，</span><span style="background-color:#ffffff; color:#ff0000; font-family:微软雅黑; font-size:12pt">DistributedFileSystem是实现</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">创建</span><span style="font-family:等线; font-size:11pt">FileSystem</span><span style="font-family:宋体; font-size:11pt">对象，调用</span><span style="font-family:等线; font-size:11pt">create</span><span style="font-family:等线; font-size:11pt">()</span><span style="font-family:宋体; font-size:11pt">向</span><span style="font-family:等线; font-size:11pt">hdfs</span><span style="font-family:宋体; font-size:11pt">请求创建一个文件</span><span style="font-family:宋体; font-size:11pt">，如果验证通过，就向</span><span style="font-family:等线; font-size:11pt">WAL</span><span style="font-family:宋体; font-size:11pt">预写日志中写入日志，</span><span style="font-family:宋体; font-size:11pt">并返回</span><span style="font-family:宋体; font-size:11pt">包装了一个</span><span style="font-family:等线; font-size:11pt">DFSOutputStream</span><span style="font-family:宋体; font-size:11pt">的</span><span style="font-family:宋体; font-size:11pt">输出流</span><span style="font-family:等线; font-size:11pt">FSDataOutputStream</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">负责与</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">、</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">通信</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">FileSystem向NN发出写文件的RPC请求。NN会</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">检查文件是否已存在、检查</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">客户端当前用户是否有创建文件的</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">权限。若通过检查，先将操作写入</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">EditLog</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">，再创建没有关联block的文件</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">。</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">1st</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">NN会对路径检查，如果有了就不能上传了，不能覆盖</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">2nd</span><span style="font:7.0pt 'Times New Roman'">&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">WAL，write ahead log，先写Log，再写内存，因为EditLog记录的是最新的HDFS客户端执行所有的写操作。如果后续真实写操作失败了，由于在真实写操作之前，操作就被写入EditLog中了，故EditLog中仍会有记录</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">NN从虚拟目录树中创建文件，定义名字，创建元数据。但此时元数据文件是没有位置信息的，需要上</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">传结束</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">后通过DN和NN的心跳来补充信息</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">1st</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">元数据是以块为单位的，无论多小的文件，都会对应一个元数据且元数据的大小都一样</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">2nd</span><span style="font:7.0pt 'Times New Roman'">&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">在上传过程中，对应文件旁边会显示copying，此时是不能读取的</span></p><p style="font-weight:normal; line-height:11.5pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(3)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果create执行成功，会返回</span><span style="background-color:#ffffff; color:#1a1a1a; font-family:微软雅黑; font-size:11.5pt">FSDataOutputStream</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">。如果失败，报IO异常。</span><span style="background-color:#ffffff; color:#1f3864; font-family:'等线 Light'; font-size:11pt">FSDataOutputStream封装了一个DFSOutputStream对象负责客户端跟datanode以及namenode的通信。而不仅仅是个简单的输出流对象</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">开始向</span><span style="background-color:#ffffff; color:#1a1a1a; font-family:微软雅黑; font-size:11.5pt">FSDataOutputStream</span><span style="font-family:宋体; font-size:11pt">输出流写数据</span><span style="font-family:宋体; font-size:11pt">。根据设置的块大小切分为块，有了</span><span style="font-family:宋体; font-size:11pt">块信息</span><span style="font-family:宋体; font-size:11pt">后</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">根据</span><span style="color:#ff0000; font-family:等线; font-size:11pt">replica</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">数、副本存放策略</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">从</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">获取</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">保存当前</span><span style="color:#ff0000; font-family:等线; font-size:11pt">block</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">的</span><span style="color:#ff0000; font-family:等线; font-size:11pt">DN</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">列表</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">DFSOutputStream</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">向NN申请根据</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">replica</span><span style="color:#ff0000; font-family:'等线 Light'; font-size:11pt">数、副本存放策略获取保存当前block的DN列表。</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">1st</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">上传是以块为单位的，无论多大的文件，都是</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">一个块一个块</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">的上传，NN只关心块，整个文件多大不关心。</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">NN</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">给HC发送dn列表是以block为单位的。</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">此处直接返回保存的列表，</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">不像读</span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">的时候仅返回可用的。</span></p><p style="font-weight:normal; line-height:10.5pt; margin:0pt 0pt 0pt 105.85pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">2nd</span><span style="font:7.0pt 'Times New Roman'">&#xa0; </span><span style="color:#262626; font-family:'等线 Light'; font-size:10.5pt">返回的dn列表是根据副本放置策略，副本放置策略是根据机架感知和节点距离选择的。</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[4]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">DFSOutputStream</span><span style="font-family:宋体; font-size:11pt">根据</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">列表、拓扑距离和最近的节点建立</span><span style="font-family:等线; font-size:11pt">socket</span><span style="font-family:宋体; font-size:11pt">连接，然后这个最近的节点按序和</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">列表中的其他节点两两依次建立链式连接，</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">并不是同所有</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">建立连接，而是形成一个链状管道，叫</span><span style="font-family:等线; font-size:11pt">pipleline</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[5]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">创建完</span><span style="font-family:等线; font-size:11pt">pipleline</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">DFSOutputStream</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">会创建</span><span style="font-family:等线; font-size:11pt">2</span><span style="font-family:宋体; font-size:11pt">个队列</span><span style="font-family:等线; font-size:11pt">data queue</span><span style="font-family:宋体; font-size:11pt">和</span><span style="font-family:等线; font-size:11pt">ack</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">queue</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="color:#ff0000; font-family:等线; font-size:11pt">[6]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">同第一个</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">进行传输，传输前会把</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">切成更小的</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">，默认</span><span style="font-family:等线; font-size:11pt">64k</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">由</span><span style="font-family:等线; font-size:11pt">chunk</span><span style="font-family:宋体; font-size:11pt">组成，每个</span><span style="font-family:等线; font-size:11pt">chunck</span><span style="font-family:宋体; font-size:11pt">默认</span><span style="font-family:等线; font-size:11pt">512k</span><span style="font-family:宋体; font-size:11pt">，另外还携带</span><span style="font-family:等线; font-size:11pt">4k</span><span style="font-family:宋体; font-size:11pt">的校验位。</span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">client</span><span style="font-family:宋体; font-size:11pt">端向</span><span style="font-family:等线; font-size:11pt">DataNode</span><span style="font-family:宋体; font-size:11pt">传数据的时候，</span><span style="font-family:等线; font-size:11pt">HDFSOutputStream</span><span style="font-family:宋体; font-size:11pt">会有一个</span><span style="font-family:等线; font-size:11pt">chunk buff</span><span style="font-family:宋体; font-size:11pt">，写满一个</span><span style="font-family:等线; font-size:11pt">chunk</span><span style="font-family:宋体; font-size:11pt">后，会校验。之后再把校验完的</span><span style="font-family:等线; font-size:11pt">chunk</span><span style="font-family:宋体; font-size:11pt">写入</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">，当一个</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">写满后，</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">会进入</span><span style="font-family:等线; font-size:11pt">dataQueue</span><span style="font-family:宋体; font-size:11pt">队列，其他的</span><span style="font-family:等线; font-size:11pt">DataNode</span><span style="font-family:宋体; font-size:11pt">就是从这个</span><span style="font-family:等线; font-size:11pt">dataQueue</span><span style="font-family:宋体; font-size:11pt">获取</span><span style="font-family:等线; font-size:11pt">client</span><span style="font-family:宋体; font-size:11pt">端上传的数据并存储的。</span><span style="font-family:等线; font-size:11pt">pipleline</span><span style="font-family:宋体; font-size:11pt">可以实现</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">同</span><span style="font-family:等线; font-size:11pt">DN1</span><span style="font-family:宋体; font-size:11pt">传输的同时，</span><span style="font-family:等线; font-size:11pt">D</span><span style="font-family:等线; font-size:11pt">N1</span><span style="font-family:宋体; font-size:11pt">、</span><span style="font-family:等线; font-size:11pt">DN2</span><span style="font-family:宋体; font-size:11pt">、</span><span style="font-family:等线; font-size:11pt">DN3</span><span style="font-family:宋体; font-size:11pt">也可以传。</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">也就是</span><span style="background-color:#ffff00; color:#ff0000; font-family:宋体; font-size:11pt">并行流式传输</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">，提高了效率。充分利用了时间线的重叠。</span><span style="font-family:宋体; font-size:11pt">切成小包的传输方式会使</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">在只给一个</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">传输的情况下，</span><span style="font-family:等线; font-size:11pt">3</span><span style="font-family:宋体; font-size:11pt">个</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">都有了数据，这样的机制不会造成</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">节点的损耗，副本数量对客户端是透明的</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果不在HC切分成小包，DN1要等64M传完才能向下传，如果带宽是64M，传完要等3秒。而切成小包，传完肯定小于3秒。</span></p><p style="line-height:10.5pt; margin:7.8pt 0pt; text-indent:115.5pt"><img src="a92f7a29-4754-491c-96a4-eb50876697cf.005.png" width="587" height="386" alt="" style="-aw-left-pos:0pt; -aw-rel-hpos:column; -aw-rel-vpos:paragraph; -aw-top-pos:0pt; -aw-wrap-type:inline" /></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[7]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">只要</span><span style="font-family:宋体; font-size:11pt">一个包</span><span style="background-color:#ffffff; color:#1a1a1a; font-family:微软雅黑; font-size:11.5pt; font-weight:bold">成功写入的节点数量达到最小副本数dfs.replication.min(默认为1)</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">就</span><span style="font-family:宋体; font-size:11pt">会</span><span style="font-family:宋体; font-size:11pt">在</span><span style="font-family:等线; font-size:11pt">pipleline</span><span style="font-family:宋体; font-size:11pt">中</span><span style="color:#ff0000; font-family:宋体; font-size:11pt">逆流</span><span style="font-family:宋体; font-size:11pt">返回</span><span style="font-family:等线; font-size:11pt">ack</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">确认信息</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">ack quence</span><span style="font-family:宋体; font-size:11pt">就会认为写入成功，会把对应的</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">从内部</span><span style="font-family:等线; font-size:11pt">data</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:等线; font-size:11pt">queue</span><span style="font-family:宋体; font-size:11pt">中删除</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[8]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">容错机制</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果pipleline上某一节点挂掉了，确认队列超过超时时间得不到确认消息，会向NN汇报。</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">pipeline</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">暂时</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">被关闭，在确认队列中的剩下的包会被添加</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">进数据</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">队列的起始位置上，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">这样</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">宕</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">机节点下游的</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">节点都不会丢失包。当前在一个好的 DataNode 会联系 NameNode，给失</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">败节点上还未写完的块生成一个新的标识</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt"> ID，如果这个失败的 DataNode 不</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">久后恢复了，根据ID把这个不完整的packet删掉，防止数据错误。同时</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">对其</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">已经上传的packet进行</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">统计，避免重复提交</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">。然后</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">从管线中删除故障数据节点</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">。剩下DN组成新的pipeline，继续传输。</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">传完之后，NN会按原有副本机制</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">进行副本校验，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">将当前pipleline上的一个节点的数据复制到一个替补</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">节点</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">，</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">维持</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">最终副本数</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">的</span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">设定。</span></p><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(2)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">如果全挂了，传输失败。</span></p><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[9]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">传完一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">收到管线中所有</span><span style="font-family:等线; font-size:11pt">datanode</span><span style="font-family:宋体; font-size:11pt">的确认消息后，通知</span><span style="font-family:等线; font-size:11pt">namenode</span><span style="font-family:宋体; font-size:11pt">当前</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">写完了</span><span style="font-family:宋体; font-size:11pt">，</span><span style="font-family:宋体; font-size:11pt">关闭输出流</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">汇报位置信息，</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">会在元数据中更新这个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的位置信息，</span><span style="font-family:宋体; font-size:11pt">汇报的同时，</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">会继续向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">请求第二个</span><span style="font-family:等线; font-size:11pt">Block</span><span style="font-family:宋体; font-size:11pt">的信息</span><span style="font-family:宋体; font-size:11pt">，重复上传</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的步骤</span><span style="font-family:宋体; font-size:11pt">，这样</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的上传</span><span style="font-family:宋体; font-size:11pt">是并行的，充分利用了时间线的重叠</span><span style="font-family:宋体; font-size:11pt">。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[10]</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:宋体; font-size:11pt">整个文件传完。</span><span style="font-family:等线; font-size:11pt">UI</span><span style="font-family:等线; font-size:11pt"> </span><span style="font-family:宋体; font-size:11pt">取消</span><span style="font-family:等线; font-size:11pt">copying</span><span style="font-family:宋体; font-size:11pt">的显示</span><span style="font-family:宋体; font-size:11pt">。</span><span style="font-family:宋体; font-size:11pt">此时别的文件就可以读取了</span></h6><p style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 91.65pt; page-break-after:avoid; page-break-inside:avoid; text-indent:0pt"><span style="font-family:'等线 Light'; font-size:11pt">(1)</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="color:#1f3864; font-family:'等线 Light'; font-size:11pt">上传过程不能读取，同一文件同一时刻只能有一个HC可以写</span></p><h5 style="font-weight:normal; line-height:11pt; margin:0pt 0pt 0pt 63.3pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">{3}</span><span style="font:7.0pt 'Times New Roman'">&#xa0;&#xa0;&#xa0;&#xa0;&#xa0; </span><span style="font-family:等线; font-size:11pt">summary</span></h5><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[1]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">向</span><span style="font-family:等线; font-size:11pt">NN</span><span style="font-family:宋体; font-size:11pt">请求</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">列表，判定副本的位置，然后构建</span><span style="font-family:等线; font-size:11pt">pipleline</span><span style="font-family:宋体; font-size:11pt">，以更小的单位</span><span style="font-family:等线; font-size:11pt">-</span><span style="font-family:宋体; font-size:11pt">包</span><span style="font-family:等线; font-size:11pt">packet</span><span style="font-family:宋体; font-size:11pt">进行流式并行传输，传完当前</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">，在</span><span style="font-family:等线; font-size:11pt">DN</span><span style="font-family:宋体; font-size:11pt">汇报位置信息的同时，</span><span style="font-family:等线; font-size:11pt">HC</span><span style="font-family:宋体; font-size:11pt">会进行下一个</span><span style="font-family:等线; font-size:11pt">block</span><span style="font-family:宋体; font-size:11pt">的上传流程。</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[2]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">块的副本对客户端是透明的</span></h6><h6 style="font-weight:normal; margin:0pt 0pt 0pt 70.9pt; text-indent:0pt"><span style="font-family:等线; font-size:11pt">[3]</span><span style="font:7.0pt 'Times New Roman'"> </span><span style="font-family:宋体; font-size:11pt">这样的机制使得文件的上传速度受副本数量影响不大，基本等于一个副本的时间。</span></h6><p style="line-height:10.5pt; margin:7.8pt 0pt"><span style="font-family:等线; font-size:10.5pt">&#xa0;</span></p></div></body></html>